<?php
$tasks = $this->tasks ?? [];

$pending = 0;
$inProgress = 0;
$completed = 0;

foreach ($tasks as $task) {
    switch ($task['status']) {
        case 'pending':
            $pending++;
            break;
        case 'in_progress':
            $inProgress++;
            break;
        case 'completed':
            $completed++;
            break;
    }
}

$total = count($tasks);


$username = $this->currentUser['username'] ?? 'Usuario';
?>

<body class="bg-gray-200">

<div class="min-h-screen flex items-center justify-center">
    <div class="bg-gray-50 max-w-4xl w-[35%] min-h-[70vh] rounded-2xl shadow-[10px_10px_0_0_#000] p-8">

        <!-- Header -->
        <div class="flex items-center justify-between">
            <div class="font-['Holtwood_One_SC',_serif] text-xl">
                Hi. <br><?php echo htmlspecialchars($username); ?>.</br>
            </div>

            <div class="font-['Baloo_2',_serif] text-xs">
                <a href="<?php echo WEB_ROOT; ?>/auth/logout" class="flex items-center gap-1">Menu
                <svg width="20" height="20">
                    <use href="#menu-icon"></use>
                </svg>   
                </a>
            </div>
        </div>

        <!-- Title -->
        <h2 class="font-['Baloo_2',_serif] mt-4">Your tasks</h2>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-4 flex items-center justify-center mt-2">
            <div class="bg-neutral-950 rounded-xl p-2.5 flex flex-col">
                <p class="font-['Holtwood_One_SC',_serif] text-white ">Total</p>
                <p class="font-['Holtwood_One_SC',_serif] text-white text-3xl self-end"><?php echo $total; ?></p>
            </div>

            <div class="bg-neutral-950 rounded-xl p-2.5 flex flex-col">
                <p class="font-['Holtwood_One_SC',_serif] text-white ">Pending</p>
                <p class="font-['Holtwood_One_SC',_serif] text-white text-3xl self-end"><?php echo $pending; ?></p>
            </div>

            <div class="bg-neutral-950 rounded-xl p-2.5 flex flex-col">
                <p class="font-['Holtwood_One_SC',_serif] text-white ">On process</p>
                <p class="font-['Holtwood_One_SC',_serif] text-white text-3xl self-end"><?php echo $inProgress; ?></p>
            </div>

            <div class="bg-neutral-950 rounded-xl p-2.5 flex flex-col">
                <p class="font-['Holtwood_One_SC',_serif] text-white ">Completed</p>
                <p class="font-['Holtwood_One_SC',_serif] text-white text-3xl self-end"><?php echo $completed; ?></p>
            </div>
        </div>

        <!-- Add task -->
        <div class="mt-4">
            <a href="/task/new" class="block text-center bg-neutral-950 text-white font-['Holtwood_One_SC',_serif]
            px-5 py-2.5 rounded-xl hover:bg-neutral-500 transition">
                Add task
            </a>
        </div>

        <!-- Task list -->
        <div class="relative mt-4 min-h-[35vh] max-h-[35vh] overflow-y-auto pr-2">
            <?php if (!empty($tasks)): ?>
                <ul class="p-0 m-0 list-none">
                    <?php foreach ($tasks as $task): ?>
                        <li class="flex items-center gap-2 py-1.5">

                        <!-- Task and line -->
                         <?php $isCompleted = $task['status'] === 'completed'; ?>
                        <div class="flex-1 border-b-2 border-black pb-1">
                            <span class="font-['Baloo_2',_serif] text-base <?= $isCompleted ? 'line-through text-neutral-400' : '' ?>">
                            <?php echo htmlspecialchars($task['title']); ?>
                            </span>
                        </div>
                        
                        <!-- On work -->
                        <?php $isInProgress = $task['status'] === 'in_progress';
                        $newStatus = $isInProgress ? 'pending' : 'in_progress';?>
                        <form action="/task/update" method="POST" style="display:inline;">
                            <input type="hidden" name="task_id" value="<?php echo $task['id']; ?>">
                            <input type="hidden" name="status" value="<?= $newStatus ?>">
                            <button type="submit" title="On process" class="font-['Baloo_2',_serif] text-black border border-neutral-800
                            hover:bg-neutral-800 hover:text-white px-4 py-1 rounded-lg transition
                            <?= $isInProgress ? 'bg-neutral-800 text-white' : 'text-black hover:bg-neutral-800 hover:text-white'?>">
                                 On work
                             </button>
                        </form>

                        <!-- Complete Task -->
                        <div class="flex items-center gap-2">
                            <form action="/task/update" method="POST" style="display:inline;">
                            <input type="hidden" name="task_id" value="<?php echo $task['id']; ?>">
                            <input type="hidden" name="status" value="completed">
                            <button type="submit" title="Completed" class="flex items-center justify-center hover:text-green-600 transition 
                            <?= $isCompleted ? 'text-green-600' : 'hover:text-green-600' ?>">
                                <svg width="24" height="24" fill="currentColor">
                                    <use href="#completed-icon"></use>
                                </svg>
                            </button>
                        </form>

                        <!-- Edit task -->

                        <a href="/task/edit?id=<?php echo $task['id']; ?>" title="Edit"
                        class="flex items-center justify-center hover:text-orange-400 transition">
                                <svg width="24" height="24" fill="currentColor">
                                    <use href="#edit-icon"></use>
                                </svg>
                        </a>

                        <!-- Delete task -->

                        <form action="/task/delete" method="POST" style="display:inline;">
                            <input type="hidden" name="task_id" value="<?php echo $task['id']; ?>">
                            <button class="flex items-center justify-center hover:text-red-600 transition" type="submit" title="Delete"
                            onclick="return confirm('Are you sure you want to delete this task?');">
                                <svg width="24" height="24" fill="currentColor">
                                    <use href="#delete-icon"></use>
                                </svg>
                            </button>
                        </form>
                        
                        </li>
                    <?php endforeach; ?>
                </ul>
            <?php else: ?>
                <div class="absolute inset-0 flex items-center justify-start p-6">
        <div class="flex items-center ">
            
            <!-- Imagen -->
            <img 
                src="<?= WEB_ROOT ?>/images/MiniGref.png" 
                alt="No tasks"
                class="w-44 opacity-30 ml-0"
            >

            <!-- Texto -->
            <p class="font-['Baloo_2',_serif] text-neutral-200 text-left text-2xl leading-tight font-bold">
                Your tasks will appear here.
            </p>

        </div>
    </div>

            <?php endif; ?>
        </div>

    </div>
</div>
</body>